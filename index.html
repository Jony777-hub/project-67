<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>IBprofen ‚Äî –ü–æ–ª–Ω–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
<style>
  /* -------- base theme -------- */
  :root{
    --bg:#0f1115; --card:#13151a; --muted:#98a2ab; --accent:#2dd4d4; --accent-2:#06b6d4;
    --glass: rgba(255,255,255,0.03);
    --radius:12px;
    --text:#e6eef2;
  }
  .light {
    --bg:#f6f8fa; --card:#ffffff; --muted:#475569; --accent:#0ea5a4; --accent-2:#028a8c; --glass: rgba(0,0,0,0.03);
    --text:#0b1020;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  .app{max-width:1200px;margin:18px auto;padding:18px}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px;border-radius:var(--radius);background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.03)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#04282a}
  h1{font-size:18px;margin:0}
  .controls{display:flex;gap:10px;align-items:center}
  select,input,textarea,button{font:inherit}
  select,input,textarea{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:var(--card);color:var(--text)}
  textarea{min-height:80px;resize:vertical}
  button{cursor:pointer;border-radius:8px;padding:8px 12px;border:none}
  .btn-primary{background:var(--accent);color:#04282a;font-weight:700}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
  .panel{background:var(--card);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
  .section-title{font-weight:700;color:var(--accent);margin:0 0 10px 0}
  .row{display:flex;gap:10px;align-items:center}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  th{color:var(--muted);font-size:13px}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:13px;color:var(--muted)}
  .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);cursor:pointer;margin-right:6px}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  input[type=file]{padding:6px}
  /* responsive */
  @media (max-width:980px){
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="brand">
      <div class="logo">IB</div>
      <div>
        <h1>IBprofen</h1>
        <div class="small">–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</div>
      </div>
    </div>

    <div class="controls">
      <select id="uiLang" title="–Ø–∑—ã–∫">
        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        <option value="en">English</option>
        <option value="kz">“ö–∞–∑–∞“õ—à–∞</option>
        <option value="zh">‰∏≠Êñá</option>
      </select>
      <button id="themeBtn" class="btn-ghost">üåì –¢–µ–º–∞</button>
      <button id="helpBtn" class="btn-ghost">–ü–æ–º–æ—â—å</button>
    </div>
  </header>

  <!-- LOGIN PANEL -->
  <div id="loginArea" class="panel" style="margin-top:18px">
    <h3 class="section-title" id="loginTitle">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>

    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px">
      <div style="flex:1;min-width:200px">
        <label class="small">–õ–æ–≥–∏–Ω</label>
        <input id="inputLogin" placeholder="–ª–æ–≥–∏–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä: admin)">
      </div>
      <div style="flex:1;min-width:200px">
        <label class="small">–ü–∞—Ä–æ–ª—å</label>
        <input id="inputPass" type="password" placeholder="–ø–∞—Ä–æ–ª—å">
      </div>
      <div style="flex:0 0 220px">
        <label class="small">–†–æ–ª—å</label>
        <select id="inputRole">
          <option value="patient">–ü–∞—Ü–∏–µ–Ω—Ç</option>
          <option value="doctor">–í—Ä–∞—á</option>
          <option value="admin">–ê–¥–º–∏–Ω</option>
        </select>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <button id="btnLogin" class="btn-primary">–í–æ–π—Ç–∏</button>
      <button id="btnRegister" class="btn-ghost">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      <div id="loginMsg" class="small" style="margin-left:8px;color:var(--muted)"></div>
    </div>

    <div style="margin-top:12px">
      <div class="small">–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥ –¥–ª—è —Ç–µ—Å—Ç–∞ (–∫–ª–∏–∫ ‚Äî –∑–∞–ø–æ–ª–Ω–∏—Ç—å)</div>
      <div style="margin-top:8px" id="quickBtns"></div>
    </div>

    <div style="margin-top:12px" class="small muted">
      –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ: –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ (localStorage). –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º backend, –ë–î –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–¥. –¥–∞–Ω–Ω—ã—Ö —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º.
    </div>
  </div>

  <!-- MAIN GRID -->
  <div id="mainGrid" style="display:none" class="grid">
    <!-- LEFT -->
    <div>
      <div class="panel" id="dashboardPanel">
        <h3 class="section-title" id="welcomeTitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h3>
        <p id="welcomeDesc" class="muted">–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –∫ –≤—Ä–∞—á—É, —Å–º–æ—Ç—Ä–µ—Ç—å –±–∞–ª–∞–Ω—Å, –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –ò–ò‚Äë–ø–æ–º–æ—â–Ω–∏–∫–æ–º –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞–º–∏ (–µ—Å–ª–∏ –≤—ã –∞–¥–º–∏–Ω).</p>

        <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
          <div style="min-width:160px" class="panel">
            <div class="small">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
            <div id="curName" style="font-weight:700">‚Äî</div>
            <div id="curRole" class="small muted">‚Äî</div>
          </div>
          <div style="min-width:160px" class="panel">
            <div class="small">–ë–∞–ª–∞–Ω—Å</div>
            <div id="curBalance" style="font-weight:700">0</div>
            <div class="small muted">–ë–æ–Ω—É—Å—ã / —à—Ç—Ä–∞—Ñ—ã</div>
          </div>
        </div>
      </div>

      <!-- APPOINTMENT MODULE -->
      <div class="panel" style="margin-top:14px">
        <h3 class="section-title" id="apptTitle">–ó–∞–ø–∏—Å—å –∫ –≤—Ä–∞—á—É</h3>

        <div class="row" style="margin-bottom:8px">
          <div style="flex:1">
            <label class="small" id="labelPatient">–ü–∞—Ü–∏–µ–Ω—Ç</label>
            <select id="selectPatient"></select>
          </div>
          <div style="flex:1">
            <label class="small" id="labelDoctor">–í—Ä–∞—á</label>
            <select id="selectDoctor"></select>
          </div>
          <div style="flex:1">
            <label class="small" id="labelDate">–î–∞—Ç–∞</label>
            <input id="selectDate" type="date"/>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <select id="timeSlot">
            <!-- times generated by JS -->
          </select>
          <button id="bookBtn" class="btn-primary">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
          <button id="viewSched" class="btn-ghost">–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
        </div>

        <div style="margin-top:12px">
          <table id="apptTable">
            <thead><tr><th>–ü–∞—Ü–∏–µ–Ω—Ç</th><th>–í—Ä–∞—á</th><th>–î–∞—Ç–∞</th><th>–í—Ä–µ–º—è</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- AI MODULE -->
      <div class="panel" style="margin-top:14px">
        <h3 class="section-title" id="aiTitle">–ò–ò‚Äë–ø–æ–º–æ—â–Ω–∏–∫</h3>
        <div class="small muted">–û–ø–∏—à–∏—Ç–µ —Å–∏–º–ø—Ç–æ–º—ã ‚Äî –ò–ò –ø–æ–¥—Å–∫–∞–∂–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤—Ä–∞—á–∞ –∏ –∫—Ä–∞—Ç–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.</div>
        <textarea id="aiInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–æ–ª–∏—Ç –∂–∏–≤–æ—Ç, —Ç–æ—à–Ω–æ—Ç–∞, —Ç–µ–º–ø 38"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="aiAsk" class="btn-primary">–°–ø—Ä–æ—Å–∏—Ç—å –ò–ò</button>
          <button id="aiClear" class="btn-ghost">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="aiResult" style="margin-top:12px" class="panel"></div>
      </div>

      <!-- ADMIN: user list & management -->
      <div class="panel" id="adminPanel" style="margin-top:14px;display:none">
        <h3 class="section-title">–ê–¥–º–∏–Ω: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
        <div style="margin-bottom:8px">
          <button id="createDemoData" class="btn-ghost">–°–æ–∑–¥–∞—Ç—å –¥–µ–º–æ‚Äë–¥–∞–Ω–Ω—ã–µ</button>
          <button id="exportData" class="btn-ghost">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
          <button id="importData" class="btn-ghost">–ò–º–ø–æ—Ä—Ç JSON</button>
          <input id="importFile" type="file" accept=".json" style="display:none"/>
        </div>
        <table id="usersTable">
          <thead><tr><th>–ò–º—è</th><th>–õ–æ–≥–∏–Ω</th><th>–†–æ–ª—å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- RIGHT SIDEBAR -->
    <div class="sidebar">
      <div class="panel">
        <h3 class="section-title">–ö–æ–º–∞–Ω–¥–∞ –∏ —Ñ–æ—Ç–æ</h3>
        <div class="small muted">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ ‚Äî –æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (DataURL)</div>
        <div style="margin-top:10px">
          <input id="photoUpload" type="file" accept="image/*"/>
        </div>
        <div id="teamList" style="margin-top:12px"></div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h3 class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <div class="small">–ü–∞—Ü–∏–µ–Ω—Ç–æ–≤: <strong id="statPatients">0</strong></div>
        <div class="small">–í—Ä–∞—á–µ–π: <strong id="statDoctors">0</strong></div>
        <div class="small">–ó–∞–ø–∏—Å–µ–π: <strong id="statAppts">0</strong></div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h3 class="section-title">–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥</h3>
        <div class="small muted">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>
        <div style="margin-top:8px" id="quickLoginArea"></div>
      </div>
    </div>
  </div>

  <footer>IBprofen ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ç–æ—Ç–∏–ø. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.</footer>
</div>

<script>
/* ========== Utilities ========== */
const $ = id => document.getElementById(id);
const nowISODate = (d=new Date()) => d.toISOString().slice(0,10);

/* ========== Persistent storage ========== */
const STORAGE_KEY = 'ibprofen_data_v1';
function loadStore(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  } catch(e){ console.error('loadStore err',e); return null; }
}
function saveStore(store){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
}

/* Default data setup if empty */
let STORE = loadStore();
if(!STORE){
  STORE = {
    users: [
      {id:1,role:'admin',login:'admin',password:'Jony707',name:'–î–æ–≤—Ä–æ–Ω–æ–≤ –ñ–æ–Ω–∏–±–µ–∫',photo:null},
      {id:2,role:'doctor',login:'imran',password:'Imran990',name:'–ù–∞–Ω–∏–µ–≤ –ò–º—Ä–∞–Ω',photo:null},
      {id:3,role:'doctor',login:'adlet',password:'Adlet990',name:'–ú”ô—Ä—ñ–ø–±–µ–∫ ”ò–¥–ª–µ—Ç',photo:null},
      {id:4,role:'patient',login:'filko',password:'Alaton1',name:'–§–∏–ª–∫–æ –ò–≤–∞–Ω',photo:null},
      {id:5,role:'patient',login:'myrz',password:'Alaton1',name:'Myrzakunurov –ê—Ä–º–∞–Ω',photo:null},
      {id:6,role:'patient',login:'dinara',password:'Alaton1',name:'Kozhamzharova –î–∏–Ω–∞—Ä–∞',photo:null},
    ],
    appointments: [], // {id, patientName, doctorName, date, time, status}
    balances: {}, // name -> number
  };
  // give initial balances
  STORE.users.filter(u=>u.role==='patient').forEach(p=>STORE.balances[p.name] = Math.floor(Math.random()*80) + 10);
  saveStore(STORE);
}

/* In-memory session */
let CURRENT = {user:null};

/* ========== UI wiring ========== */
function initUI(){
  // quick login chips
  const quickArea = $('quickBtns');
  quickArea.innerHTML='';
  STORE.users.forEach(u=>{
    const chip = document.createElement('div'); chip.className='chip'; chip.textContent = `${u.name} (${u.role})`;
    chip.onclick = ()=>{ $('inputLogin').value = u.login; $('inputPass').value = u.password; };
    quickArea.appendChild(chip);
  });

  // quick login buttons in sidebar
  const qArea = $('quickLoginArea'); qArea.innerHTML='';
  STORE.users.forEach(u=>{
    const b = document.createElement('button'); b.className='chip'; b.textContent=u.login; 
    b.onclick = ()=> { doLogin(u.login, u.password); };
    qArea.appendChild(b);
  });

  // time slots
  const timeSlot = $('timeSlot'); timeSlot.innerHTML='';
  const slots = ['09:00','09:30','10:00','10:30','11:00','11:30','13:00','13:30','14:00','14:30','15:00','15:30'];
  slots.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; timeSlot.appendChild(o); });

  // quick file upload
  $('photoUpload').addEventListener('change', e=>{
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ev => {
      // set sample: attach to current user's photo if logged
      if(CURRENT.user){
        const u = STORE.users.find(x=>x.login===CURRENT.user.login);
        if(u){ u.photo = ev.target.result; saveStore(STORE); renderTeam(); alert('–§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–ª—è '+u.name); return; }
      }
      // Otherwise store as team extra (push)
      STORE.users.push({id: Date.now(), role:'other', login:'user'+Date.now(), password:'', name:f.name, photo:ev.target.result});
      saveStore(STORE);
      renderTeam();
      alert('–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–º–∞–Ω–¥—É (–ª–æ–∫–∞–ª—å–Ω–æ).');
    };
    reader.readAsDataURL(f);
  });

  // buttons
  $('btnLogin').addEventListener('click', ()=> doLogin($('inputLogin').value.trim(), $('inputPass').value));
  $('btnRegister').addEventListener('click', doRegister);

  $('bookBtn').addEventListener('click', onBook);
  $('viewSched').addEventListener('click', renderAppointmentsTable);

  $('aiAsk').addEventListener('click', onAskAI);
  $('aiClear').addEventListener('click', ()=>{ $('aiInput').value=''; $('aiResult').innerHTML=''; });

  $('themeBtn').addEventListener('click', ()=> document.body.classList.toggle('light'));
  $('helpBtn').addEventListener('click', ()=> alert('IBprofen ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞—è –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è. –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω—É–∂–µ–Ω backend –∏ –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö.'));

  $('createDemoData').addEventListener('click', createDemoData);
  $('exportData').addEventListener('click', ()=> {
    const a = document.createElement('a');
    a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(STORE,null,2));
    a.download = 'ibprofen_export.json';
    a.click();
  });
  $('importData').addEventListener('click', ()=> $('importFile').click());
  $('importFile').addEventListener('change', (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ev => {
      try{
        const data = JSON.parse(ev.target.result);
        if(confirm('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—É—â–∏–µ?')){ STORE = data; saveStore(STORE); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ'); location.reload(); }
      }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); }
    };
    r.readAsText(f);
  });

  renderTeam();
  updateStats();
  populateSelects();
  renderUsersTable();
  renderAppointmentsTable();
  renderBalances();
}

/* ========== Auth ========== */
function doLogin(login, pass){
  const msg = $('loginMsg');
  const u = STORE.users.find(x=>x.login===login && x.password===pass);
  if(!u){ msg.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å'; return; }
  CURRENT.user = u;
  $('loginArea').style.display='none';
  $('mainGrid').style.display='grid';
  $('curName').innerText = u.name;
  $('curRole').innerText = u.role.toUpperCase();
  $('curBalance').innerText = STORE.balances[u.name] ?? 0;
  // admin panel visibility
  $('adminPanel').style.display = (u.role==='admin') ? 'block' : 'none';
  // load user-specific UI
  populateSelects();
  renderAppointmentsTable();
  renderBalances();
  updateStats();
  $('loginMsg').textContent = '';
}

function doRegister(){
  const login = $('inputLogin').value.trim();
  const pass = $('inputPass').value;
  const role = $('inputRole').value;
  if(!login || !pass){ alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å'); return; }
  if(STORE.users.some(u=>u.login===login)){ alert('–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç'); return; }
  const name = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è (–∫–∞–∫ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å):', login) || login;
  const newUser = {id: Date.now(), role, login, password:pass, name, photo:null};
  STORE.users.push(newUser);
  if(role==='patient') STORE.balances[newUser.name] = 0;
  saveStore(STORE);
  initUI();
  renderUsersTable();
  alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω. –í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É.');
}

/* ========== Appointments logic ========== */
function populateSelects(){
  const sP = $('selectPatient'), sD = $('selectDoctor');
  sP.innerHTML=''; sD.innerHTML='';
  STORE.users.filter(u=>u.role==='patient').forEach(p=>{
    const o=document.createElement('option'); o.value=p.name; o.textContent=p.name; sP.appendChild(o);
  });
  STORE.users.filter(u=>u.role==='doctor').forEach(d=>{
    const o=document.createElement('option'); o.value=d.name; o.textContent=d.name; sD.appendChild(o);
  });

  // if current user is patient, preselect them
  if(CURRENT.user && CURRENT.user.role==='patient'){
    sP.value = CURRENT.user.name;
  }
}

function onBook(){
  const patient = $('selectPatient').value;
  const doctor = $('selectDoctor').value;
  const date = $('selectDate').value;
  const time = $('timeSlot').value;
  if(!patient || !doctor || !date || !time){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return; }
  // check conflict: same doctor same date and same time
  const conflict = STORE.appointments.some(a=> a.doctorName===doctor && a.date===date && a.time===time);
  if(conflict){ alert('–£ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–∞—á–∞ —É–∂–µ –µ—Å—Ç—å –∑–∞–ø–∏—Å—å –≤ —ç—Ç–æ –≤—Ä–µ–º—è'); return; }
  const id = Date.now() + Math.floor(Math.random()*1000);
  STORE.appointments.push({id, patientName:patient, doctorName:doctor, date, time, status:'–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ'});
  saveStore(STORE);
  renderAppointmentsTable();
  updateStats();
  alert(`–£—Å–ø–µ—à–Ω–æ: ${patient} ‚Üí ${doctor} ${date} ${time}`);
}

function renderAppointmentsTable(){
  const tbody = document.querySelector('#apptTable tbody');
  tbody.innerHTML='';
  // filter based on role: doctor sees only their appointments; patient sees only theirs; admin sees all
  let list = STORE.appointments.slice().sort((a,b)=> (a.date > b.date)?1:-1);
  if(CURRENT.user){
    if(CURRENT.user.role==='doctor') list = list.filter(x=>x.doctorName===CURRENT.user.name);
    if(CURRENT.user.role==='patient') list = list.filter(x=>x.patientName===CURRENT.user.name);
  } else {
    // if not logged, show none
    list = [];
  }
  list.forEach(a=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${a.patientName}</td><td>${a.doctorName}</td><td>${a.date}</td><td>${a.time}</td><td>${a.status}</td>`;
    tbody.appendChild(tr);
  });
}

/* ========== Balances & bonuses ========== */
function renderBalances(){
  const tbody = document.querySelector('#bonusTable tbody');
  tbody.innerHTML='';
  Object.keys(STORE.balances).forEach(name=>{
    const bonuses = Math.floor(STORE.balances[name]/2);
    const penalties = Math.floor(Math.random()*3);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${name}</td><td>${bonuses}</td><td>${penalties}</td><td>${STORE.balances[name]}</td>`;
    tbody.appendChild(tr);
  });
}

/* ========== AI assistant (keyword mapping) ========== */
const AI_RULES = [
  {keys: ['–∂–∏–≤–æ—Ç','–±–æ–ª—å –≤ –∂–∏–≤–æ—Ç–µ','—Ç–æ—à–Ω–æ','—Ç–æ—à–Ω–æ—Ç–∞','—Ä–≤–æ—Ç–∞','–¥–∏–∞—Ä–µ—è','–ø–µ—á–µ–Ω—å','–≥–∞—Å—Ç—Ä–∏—Ç'], doctor:'–ì–∞—Å—Ç—Ä–æ—ç–Ω—Ç–µ—Ä–æ–ª–æ–≥', advice:'–ü–æ—Ö–æ–∂–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã –ñ–ö–¢ ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≥–∞—Å—Ç—Ä–æ—ç–Ω—Ç–µ—Ä–æ–ª–æ–≥.'},
  {keys: ['–≥–ª–∞–∑–∞','–∑—Ä–µ–Ω–∏–µ','—Å–ª–µ–ø','—Ä–µ–∑—å','–∑—É–¥ –≥–ª–∞–∑'], doctor:'–û—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥', advice:'–ü—Ä–æ–±–ª–µ–º—ã —Å–æ –∑—Ä–µ–Ω–∏–µ–º ‚Äî –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –æ—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥—É.'},
  {keys: ['–≥–æ–ª–æ–≤–∞','–≥–æ–ª–æ–≤–Ω–∞—è','–º–∏–≥—Ä–µ–Ω—å','–≥–æ–ª–æ–≤–æ–∫—Ä—É–∂–µ–Ω–∏–µ'], doctor:'–ù–µ–≤—Ä–æ–ª–æ–≥', advice:'–ù–µ–≤—Ä–æ–ª–æ–≥ –ø–æ–º–æ–∂–µ—Ç –ø—Ä–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –≥–æ–ª–æ–≤–Ω—ã—Ö –±–æ–ª—è—Ö.'},
  {keys: ['—Å–µ—Ä–¥—Ü–µ','–±–æ–ª—å –≤ –≥—Ä—É–¥–∏','—Ç–∞—Ö–∏–∫–∞—Ä–¥'], doctor:'–ö–∞—Ä–¥–∏–æ–ª–æ–≥', advice:'–ë–æ–ª—å –≤ –≥—Ä—É–¥–∏ ‚Äî —Å—Ä–æ—á–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∫–∞—Ä–¥–∏–æ–ª–æ–≥—É.'},
  {keys: ['–∫–∞—à–µ–ª—å','–≥–æ—Ä–ª–æ','–∞–Ω–≥–∏–Ω–∞','–≥–æ—Ä–ª–æ –±–æ–ª–∏—Ç'], doctor:'–¢–µ—Ä–∞–ø–µ–≤—Ç', advice:'–ù–∞—á–Ω–∏—Ç–µ —Å —Ç–µ—Ä–∞–ø–µ–≤—Ç–∞ –∏–ª–∏ –õ–û–†–∞ –ø—Ä–∏ –±–æ–ª–∏ –≤ –≥–æ—Ä–ª–µ –∏ –∫–∞—à–ª–µ.'},
  {keys: ['—Å—ã–ø—å','–∞–ª–ª–µ—Ä–≥','–∑—É–¥','–∫—Ä–∞–ø–∏–≤–Ω–∏—Ü–∞'], doctor:'–ê–ª–ª–µ—Ä–≥–æ–ª–æ–≥', advice:'–í–æ–∑–º–æ–∂–Ω–æ –∞–ª–ª–µ—Ä–≥–∏—è ‚Äî –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–ª–ª–µ—Ä–≥–æ–ª–æ–≥—É.'},
  {keys: ['—à–∫–∞–ª–∞','–¥–µ–ø—Ä–µ—Å—Å','—Ç—Ä–µ–≤–æ–≥–∞','—Å–æ–Ω'], doctor:'–ü—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç', advice:'–ï—Å–ª–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã ‚Äî –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç –ø–æ–º–æ–∂–µ—Ç.'},
  {keys: ['—Å–∞—Ö–∞—Ä','–¥–∏–∞–±–µ—Ç','–≥–ª—é–∫–æ–∑–∞'], doctor:'–≠–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥', advice:'–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Ä–æ–≤–µ–Ω—å —Å–∞—Ö–∞—Ä–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —ç–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥—É.'},
];

function aiSuggest(text){
  if(!text || text.trim().length < 2) return {doctor:null, advice:'–û–ø–∏—à–∏—Ç–µ —Å–∏–º–ø—Ç–æ–º—ã –ø–æ–¥—Ä–æ–±–Ω–µ–µ.'};
  const s = text.toLowerCase();
  for(const rule of AI_RULES){
    for(const k of rule.keys){
      if(s.includes(k)) return {doctor:rule.doctor, advice:rule.advice};
    }
  }
  // fallback
  if(s.includes('—Ç–µ–º–ø–µ—Ä–∞') || s.includes('–∂–∞—Ä')) return {doctor:'–¢–µ—Ä–∞–ø–µ–≤—Ç', advice:'–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ‚Äî —Å–≤—è–∂–∏—Ç–µ—Å—å —Å —Ç–µ—Ä–∞–ø–µ–≤—Ç–æ–º.'};
  return {doctor:'–¢–µ—Ä–∞–ø–µ–≤—Ç', advice:'–ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ ‚Äî –Ω–∞—á–Ω–∏—Ç–µ —Å —Ç–µ—Ä–∞–ø–µ–≤—Ç–∞.'};
}

function onAskAI(){
  const txt = $('aiInput').value.trim();
  const out = $('aiResult');
  out.innerHTML = '<div class="small muted">–û–±—Ä–∞–±–æ—Ç–∫–∞...</div>';
  setTimeout(()=>{
    const res = aiSuggest(txt);
    out.innerHTML = `<div style="font-weight:700">${res.doctor ?? '–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –≤—Ä–∞—á'}</div><div class="muted" style="margin-top:6px">${res.advice}</div>`;
    // add quick book button
    const quick = document.createElement('div'); quick.style.marginTop='8px';
    const bookBtn = document.createElement('button'); bookBtn.className='btn-primary'; bookBtn.textContent='–ê–≤—Ç–æ–∑–∞–ø–∏—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É';
    bookBtn.onclick = ()=> {
      // prefill patient (current patient if any), doctor -> first doctor, date -> tomorrow
      if(CURRENT.user && CURRENT.user.role==='patient') $('selectPatient').value = CURRENT.user.name;
      // choose a doctor with role doctor (we don't map specialty->specific doctor in demo)
      const doc = STORE.users.find(u=>u.role==='doctor');
      if(doc) $('selectDoctor').value = doc.name;
      const t = new Date(Date.now() + 24*3600*1000);
      $('selectDate').value = t.toISOString().slice(0,10);
      alert('–ü–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è" –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
    };
    quick.appendChild(bookBtn);
    out.appendChild(quick);
  }, 400);
}

/* ========== Team render (photos) ========== */
function renderTeam(){
  const root = $('teamList');
  root.innerHTML='';
  STORE.users.filter(u => ['admin','doctor','patient'].includes(u.role)).forEach(u=>{
    const div = document.createElement('div'); div.style.display='flex'; div.style.gap='10px'; div.style.alignItems='center'; div.style.marginBottom='10px';
    const img = document.createElement('div'); img.style.width='48px'; img.style.height='48px'; img.style.borderRadius='8px';
    if(u.photo){ img.style.backgroundImage=`url(${u.photo})`; img.style.backgroundSize='cover'; } else { img.style.background='linear-gradient(135deg,var(--accent),var(--accent-2))'; img.style.color='#04282a'; img.style.display='flex'; img.style.alignItems='center'; img.style.justifyContent='center'; img.style.fontWeight='700'; img.textContent = u.name.split(' ').map(s=>s[0]).slice(0,2).join(''); }
    const info = document.createElement('div'); info.innerHTML = `<div style="font-weight:700">${u.name}</div><div class="small muted">${u.role}</div>`;
    div.appendChild(img); div.appendChild(info); root.appendChild(div);
  });
}

/* ========== Admin users table ========== */
function renderUsersTable(){
  const tbody = document.querySelector('#usersTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';
  STORE.users.forEach(u=>{
    const tr = document.createElement('tr');
    const actions = [];
    actions.push(`<button class="btn-ghost" onclick="editUser(${u.id})">–ò–∑–º.</button>`);
    actions.push(`<button class="btn-ghost" onclick="removeUser(${u.id})">–£–¥–∞–ª.</button>`);
    tr.innerHTML = `<td>${u.name}</td><td>${u.login}</td><td>${u.role}</td><td>${actions.join(' ')}</td>`;
    tbody.appendChild(tr);
  });
}
window.editUser = function(id){
  const u = STORE.users.find(x=>x.id===id);
  if(!u) return alert('–ù–µ –Ω–∞–π–¥–µ–Ω');
  const name = prompt('–ò–º—è', u.name);
  if(name!==null) u.name = name;
  const pass = prompt('–ü–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)');
  if(pass) u.password = pass;
  saveStore(STORE);
  renderUsersTable();
  renderTeam();
};
window.removeUser = function(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
  STORE.users = STORE.users.filter(u=>u.id!==id);
  // clean balances and appointments for that user
  // (for demo we'll leave balances)
  saveStore(STORE);
  renderUsersTable();
  renderTeam();
  populateSelects();
  renderAppointmentsTable();
  renderBalances();
};

/* ========== Create demo data ========== */
function createDemoData(){
  if(!confirm('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–º–æ –∑–∞–ø–∏—Å–∏ –∏ –±–∞–ª–∞–Ω—Å—ã?')) return;
  // add 30 random appts
  const patients = STORE.users.filter(u=>u.role==='patient').map(u=>u.name);
  const doctors = STORE.users.filter(u=>u.role==='doctor').map(u=>u.name);
  const today = new Date();
  for(let i=0;i<30;i++){
    const d = new Date(today.getTime() + (i+1)*24*3600*1000);
    const date = d.toISOString().slice(0,10);
    const time = ['09:00','10:00','11:00','13:00','14:00','15:00'][i%6];
    STORE.appointments.push({id:Date.now()+i, patientName:patients[i%patients.length], doctorName:doctors[i%doctors.length], date, time, status: (i%4===0)?'–ó–∞–≤–µ—Ä—à–µ–Ω–æ':'–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ'});
  }
  // bump balances
  STORE.users.filter(u=>u.role==='patient').forEach(p=> STORE.balances[p.name] = (STORE.balances[p.name]||0) + Math.floor(Math.random()*30));
  saveStore(STORE);
  populateSelects(); renderAppointmentsTable(); renderBalances(); updateStats();
  alert('–î–µ–º–æ –¥–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã');
}

/* ========== Stats update ========== */
function updateStats(){
  $('statPatients').innerText = STORE.users.filter(u=>u.role==='patient').length;
  $('statDoctors').innerText = STORE.users.filter(u=>u.role==='doctor').length;
  $('statAppts').innerText = STORE.appointments.length;
}

/* ========== Misc helpers ========== */
function updateCurrentBalanceDisplay(){
  if(CURRENT.user) $('curBalance').innerText = STORE.balances[CURRENT.user.name] ?? 0;
}

/* Initialize on load */
initUI();

/* helper to repopulate after login/register */
function renderBalances(){ renderBalances; } // placeholder to avoid lint issues
// but call actual function defined earlier:
renderBalances = renderBalances; // no-op (keeps consistent)

(function finishInit(){
  populateSelects();
  renderTeam();
  renderUsersTable();
  renderAppointmentsTable();
  renderBalances();
  updateStats();
})();

/* Language basic mapping */
const LABELS = {
  ru: {
    loginTitle: '–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
    welcomeTitle: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å',
    apptTitle: '–ó–∞–ø–∏—Å—å –∫ –≤—Ä–∞—á—É',
    aiTitle: '–ò–ò‚Äë–ø–æ–º–æ—â–Ω–∏–∫',
    bookBtn: '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è',
    viewSched: '–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ',
  },
  en: {
    loginTitle: 'Sign in / Register',
    welcomeTitle: 'Welcome',
    apptTitle: 'Appointment',
    aiTitle: 'AI Assistant',
    bookBtn: 'Book',
    viewSched: 'Show schedule',
  },
  kz: {
    loginTitle: '–ö—ñ—Ä—É / –¢—ñ—Ä–∫–µ—É',
    welcomeTitle: '“ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑',
    apptTitle: '–î”ô—Ä—ñ–≥–µ—Ä–≥–µ –∂–∞–∑—ã–ª—É',
    aiTitle: '–ò–ò –∫”©–º–µ–∫—à—ñ',
    bookBtn: '–ñ–∞–∑—ã–ª—É',
    viewSched: '–ö–µ—Å—Ç–µ–Ω—ñ –∫”©—Ä—Å–µ—Ç—É',
  },
  zh: {
    loginTitle: 'ÁôªÂΩï / Ê≥®ÂÜå',
    welcomeTitle: 'Ê¨¢Ëøé',
    apptTitle: 'È¢ÑÁ∫¶',
    aiTitle: 'AI Âä©Êâã',
    bookBtn: 'È¢ÑÁ∫¶',
    viewSched: 'ÊòæÁ§∫Êó•Á®ã',
  }
};
$('uiLang').addEventListener('change', ()=>{
  const L = $('uiLang').value;
  const d = LABELS[L] || LABELS.ru;
  $('loginTitle').textContent = d.loginTitle;
  $('welcomeTitle').textContent = d.welcomeTitle;
  $('apptTitle').textContent = d.apptTitle;
  $('aiTitle').textContent = d.aiTitle;
  $('bookBtn').textContent = d.bookBtn;
  $('viewSched').textContent = d.viewSched;
});

/* Fix for renderBalances variable confusion above: define real function now */
function renderBalances(){
  const tbody = document.querySelector('#bonusTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';
  Object.keys(STORE.balances).forEach(name=>{
    const bonuses = Math.floor(STORE.balances[name]/2);
    const penalties = Math.floor(Math.random()*3);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${name}</td><td>${bonuses}</td><td>${penalties}</td><td>${STORE.balances[name]}</td>`;
    tbody.appendChild(tr);
  });
  updateCurrentBalanceDisplay();
}

/* Ensure selects/timeSlots ready */
populateSelects();
renderTeam();
updateStats();

/* End of script */
</script>
</body>
</html>
